# Development Brief (v1): Unified Service Client Architecture

**Version**: v0.32.5    
**Date**: January 2025  
**Status**: Proposed  
**Affected Projects**: 
- `osbot_fast_api`
- `mgraph_ai_service_cache_client`
- `mgraph_ai_service_cache`
- `mgraph_ai_service_html_graph_client`
- `mgraph_ai_service_html_graph`
- Future service clients

---

## Executive Summary

This document describes a unified architecture for FastAPI service clients that enables seamless switching between IN_MEMORY (TestClient) and REMOTE (HTTP) modes without code changes. The architecture centralizes transport logic, eliminates redundant wrapper classes, and establishes clear patterns for all current and future service clients.

---

## Part 1: How We Got Here

### 1.1 Original Problem

Our microservices architecture had grown organically, resulting in:

- **Duplicate transport logic** in every service client
- **Multiple wrapper classes** per service (e.g., `Cache__Service__Fast_API__Client`, `Cache__Service__In_Memory`, `Cache__Service__Registry__Client`)
- **Inconsistent patterns** across different service clients
- **Config duplication** between registry and client configs
- **Unclear ownership** of the FastAPI app in IN_MEMORY mode

### 1.2 The Registry Pattern (Phase 1)

We first introduced `Fast_API__Service__Registry` to centralize service discovery:

```python
# Registration
registry.register(cache_client)

# Discovery
cache_client = registry.client(Cache__Service__Registry__Client)
```

This solved discovery but introduced new problems:
- Registry client wrapper (`Cache__Service__Registry__Client`) duplicating the actual client (`Cache__Service__Fast_API__Client`)
- Config fields duplicated between `Fast_API__Service__Registry__Client__Config` and `Cache__Service__Fast_API__Client__Config`

### 1.3 Questioning `Cache__Service__In_Memory` (Phase 2)

We asked: **"Why do we need the `Cache__Service__In_Memory` class?"**

Analysis revealed it was mixing two concerns:
1. **Server-side**: Creating `Cache__Service` + `Cache_Service__Fast_API`
2. **Client-side**: Creating `Cache__Service__Fast_API__Client`

The insight: This class is just **bootstrapping glue**. The client doesn't need to know how the FastAPI app was created — it just needs a configured `fast_api_app` in its config.

**Decision**: Replace `Cache__Service__In_Memory` with a simple registration function.

### 1.4 Package Dependency Analysis (Phase 3)

Understanding the one-way dependency was critical:

```
mgraph_ai_service_cache (heavy - has FastAPI, routes, business logic)
    │
    └── depends on ──► mgraph_ai_service_cache_client (light - schemas, client only)
```

**Key constraints**:
- Client package **never** imports from Service package
- All schemas live in Client package
- Service package can create FastAPI apps; Client package cannot

**Mode availability by installation**:

| Installed | Available Modes |
|-----------|----------------|
| Client only | REMOTE only |
| Client + Service | REMOTE and IN_MEMORY |

### 1.5 Discovering the Generic Transport (Phase 4)

Examining `Cache__Service__Fast_API__Client__Requests`, we realized it was **100% generic**:

```python
def execute(self, method, path, body, headers):
    if self.config.mode == IN_MEMORY:
        return self._execute_in_memory(...)   # TestClient
    else:
        return self._execute_remote(...)      # requests library
```

Nothing Cache-specific. This class should live in `osbot_fast_api` and be shared by all service clients.

**Decision**: Promote to `Fast_API__Client__Requests` in `osbot_fast_api`.

### 1.6 Eliminating Wrapper Layers (Phase 5)

We had three classes doing one job:

```
Cache__Service__Fast_API__Client      # Domain methods
Cache__Service__Registry__Client      # Registry wrapper  
Cache__Service__In_Memory             # Setup helper
```

**Decision**: Merge into single `Cache__Service__Client`.

### 1.7 Cleaning Up Naming (Phase 6)

Names like `Cache__Service__Registry__Client` leak implementation details. The "Registry" is **how** it's managed, not **what** it is.

**Before**:
- `Cache__Service__Fast_API__Client`
- `Cache__Service__Registry__Client`

**After**:
- `Cache__Service__Client`

The inheritance (`extends Fast_API__Service__Registry__Client__Base`) communicates registry compatibility — the name doesn't need to.

---

## Part 2: Final Architecture

### 2.1 Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Application Layer                                  │
│  (Business logic discovers clients via registry)                            │
│                                                                             │
│    cache_client = registry.client(Cache__Service__Client)                   │
│    cache_client.store().store__json__cache_key(...)                         │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Service Client Layer                                 │
│  (Domain-specific clients in each *_client package)                         │
│                                                                             │
│    Cache__Service__Client                                                   │
│    Html__Service__Client                                                    │
│    Html_Graph__Service__Client                                              │
│    LLM__Service__Client                                                     │
│                                                                             │
│    Each extends Fast_API__Service__Registry__Client__Base                   │
│    Each has domain methods: store(), retrieve(), transform(), etc.          │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                        Infrastructure Layer                                  │
│  (Generic transport in osbot_fast_api)                                      │
│                                                                             │
│    Fast_API__Service__Registry           - Client registration/discovery    │
│    Fast_API__Service__Registry__Client__Base    - Base class for clients    │
│    Fast_API__Service__Registry__Client__Config  - Shared config schema      │
│    Fast_API__Client__Requests            - Generic IN_MEMORY/REMOTE transport│
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 Package Structure

#### osbot_fast_api (Infrastructure)

```
osbot_fast_api/
└── services/
    └── registry/
        ├── Fast_API__Service__Registry.py
        ├── Fast_API__Service__Registry__Client__Base.py
        └── Fast_API__Client__Requests.py
    └── schemas/
        └── registry/
            ├── Fast_API__Service__Registry__Client__Config.py
            ├── enums/
            │   └── Enum__Fast_API__Service__Registry__Client__Mode.py
            └── collections/
                ├── Dict__Fast_API__Service__Clients_By_Type.py
                └── List__Fast_API__Service__Client_Types.py
```

#### mgraph_ai_service_cache_client (Domain Client)

```
mgraph_ai_service_cache_client/
└── client/
    ├── Cache__Service__Client.py           # Main client class
    ├── Cache__Service__Client__Requests.py # Extends Fast_API__Client__Requests
    ├── store/
    │   └── Service__Client__File__Store.py
    ├── retrieve/
    │   └── Service__Client__File__Retrieve.py
    └── ... (other domain operations)
└── schemas/
    └── ... (all schemas)
```

#### mgraph_ai_service_cache (Service - Registration Helpers)

```
mgraph_ai_service_cache/
└── registration/
    └── register_cache_service.py           # Simple function, not a class
```

### 2.3 Class Definitions

#### Fast_API__Client__Requests (Generic Transport)

```python
# osbot_fast_api/services/registry/Fast_API__Client__Requests.py

from typing                                                           import Type, Any, Dict, Optional
from osbot_utils.type_safe.Type_Safe                                  import Type_Safe
from osbot_utils.decorators.methods.cache_on_self                     import cache_on_self
from starlette.testclient                                             import TestClient
from osbot_fast_api.services.registry.Fast_API__Service__Registry     import fast_api__service__registry
from osbot_fast_api.services.registry.Fast_API__Service__Registry__Client__Base import Fast_API__Service__Registry__Client__Base
from osbot_fast_api.services.schemas.registry.enums.Enum__Fast_API__Service__Registry__Client__Mode import Enum__Fast_API__Service__Registry__Client__Mode
import requests


class Fast_API__Client__Requests(Type_Safe):
    service_type : Type[Fast_API__Service__Registry__Client__Base] = None       # Subclass overrides this

    @property
    def config(self):                                                           # Get config from registry
        client = fast_api__service__registry.client(self.service_type)
        if client is None:
            raise ValueError(f"{self.service_type.__name__} not registered in service registry")
        return client.config

    @cache_on_self
    def test_client(self):                                                      # TestClient for IN_MEMORY mode
        if self.config.fast_api_app is None:
            raise ValueError("IN_MEMORY mode requires fast_api_app in config")
        return TestClient(self.config.fast_api_app)

    @cache_on_self
    def session(self):                                                          # requests.Session for REMOTE mode
        session = requests.Session()
        if self.config.api_key_value:
            session.headers['Authorization'] = f'Bearer {self.config.api_key_value}'
        return session

    def execute(self, method  : str                ,                            # HTTP method (GET, POST, etc)
                      path    : str                ,                            # Endpoint path
                      body    : Any          = None,                            # Request body
                      headers : Optional[Dict] = None                           # Additional headers
               ):                                                               # Execute request based on mode
        request_headers = {**self.auth_headers(), **(headers or {})}

        if self.config.mode == Enum__Fast_API__Service__Registry__Client__Mode.IN_MEMORY:
            return self.execute_in_memory(method, path, body, request_headers)
        elif self.config.mode == Enum__Fast_API__Service__Registry__Client__Mode.REMOTE:
            return self.execute_remote(method, path, body, request_headers)
        else:
            raise ValueError("Client mode not configured")

    def execute_in_memory(self, method: str, path: str, body: Any, headers: Dict):
        method_func = getattr(self.test_client(), method.lower())
        if body:
            if type(body) is bytes:
                headers["Content-Type"] = "application/octet-stream"
                return method_func(path, data=body, headers=headers)
            else:
                return method_func(path, json=body, headers=headers)
        return method_func(path, headers=headers)

    def execute_remote(self, method: str, path: str, body: Any, headers: Dict):
        url = f"{self.config.base_url}{path}"
        method_func = getattr(self.session(), method.lower())
        if body:
            if type(body) is bytes:
                headers["Content-Type"] = "application/octet-stream"
                return method_func(url, data=body, headers=headers)
            else:
                return method_func(url, json=body, headers=headers)
        return method_func(url, headers=headers)

    def auth_headers(self) -> Dict[str, str]:                                   # Get auth headers from config
        headers = {}
        if self.config.api_key_name and self.config.api_key_value:
            headers[str(self.config.api_key_name)] = str(self.config.api_key_value)
        return headers
```

#### Cache__Service__Client__Requests (Domain Extension)

```python
# mgraph_ai_service_cache_client/client/Cache__Service__Client__Requests.py

from typing                                                           import Type
from osbot_fast_api.services.registry.Fast_API__Client__Requests      import Fast_API__Client__Requests
from osbot_fast_api.services.registry.Fast_API__Service__Registry__Client__Base import Fast_API__Service__Registry__Client__Base


class Cache__Service__Client__Requests(Fast_API__Client__Requests):
    service_type : Type[Fast_API__Service__Registry__Client__Base] = None       # Set at runtime by client
```

#### Cache__Service__Client (Domain Client)

```python
# mgraph_ai_service_cache_client/client/Cache__Service__Client.py

from typing                                                                     import Type
from osbot_fast_api.services.registry.Fast_API__Service__Registry__Client__Base import Fast_API__Service__Registry__Client__Base
from osbot_fast_api.services.schemas.registry.collections.List__Fast_API__Registry__Env_Vars import List__Fast_API__Registry__Env_Vars
from osbot_fast_api.services.schemas.registry.Schema__Fast_API__Registry__Env_Var import Schema__Fast_API__Registry__Env_Var
from osbot_utils.decorators.methods.cache_on_self                               import cache_on_self
from mgraph_ai_service_cache_client.client.Cache__Service__Client__Requests     import Cache__Service__Client__Requests
from mgraph_ai_service_cache_client.schemas.consts.consts__Cache_Client         import ENV_VAR__URL__TARGET_SERVER__CACHE_SERVICE
from mgraph_ai_service_cache_client.schemas.consts.consts__Cache_Client         import ENV_VAR__AUTH__TARGET_SERVER__CACHE_SERVICE__KEY_NAME
from mgraph_ai_service_cache_client.schemas.consts.consts__Cache_Client         import ENV_VAR__AUTH__TARGET_SERVER__CACHE_SERVICE__KEY_VALUE


class Cache__Service__Client(Fast_API__Service__Registry__Client__Base):

    @cache_on_self
    def requests(self) -> Cache__Service__Client__Requests:                     # Transport layer
        requests = Cache__Service__Client__Requests()
        requests.service_type = Cache__Service__Client                          # Self-reference for registry lookup
        return requests

    def health(self) -> bool:                                                   # Health check
        try:
            result = self.info().health()
            return result.get('status') == 'ok'
        except:
            return False

    # ───────────────────────────────────────────────────────────────────────────
    # Domain Methods
    # ───────────────────────────────────────────────────────────────────────────

    @cache_on_self
    def store(self):
        from mgraph_ai_service_cache_client.client.store.Service__Client__File__Store import Service__Client__File__Store
        return Service__Client__File__Store(_client=self)

    @cache_on_self
    def retrieve(self):
        from mgraph_ai_service_cache_client.client.retrieve.Service__Client__File__Retrieve import Service__Client__File__Retrieve
        return Service__Client__File__Retrieve(_client=self)

    @cache_on_self
    def info(self):
        from mgraph_ai_service_cache_client.client.info.Service__Client__Info import Service__Client__Info
        return Service__Client__Info(_client=self)

    @cache_on_self
    def exists(self):
        from mgraph_ai_service_cache_client.client.exists.Service__Client__File__Exists import Service__Client__File__Exists
        return Service__Client__File__Exists(_client=self)

    @cache_on_self
    def delete(self):
        from mgraph_ai_service_cache_client.client.delete.Service__Client__File__Delete import Service__Client__File__Delete
        return Service__Client__File__Delete(_client=self)

    @cache_on_self
    def namespace(self):
        from mgraph_ai_service_cache_client.client.namespace.Service__Client__Namespace import Service__Client__Namespace
        return Service__Client__Namespace(_client=self)

    @cache_on_self
    def namespaces(self):
        from mgraph_ai_service_cache_client.client.namespaces.Service__Client__Namespaces import Service__Client__Namespaces
        return Service__Client__Namespaces(_client=self)

    # ───────────────────────────────────────────────────────────────────────────
    # Registry Contract
    # ───────────────────────────────────────────────────────────────────────────

    @classmethod
    def env_vars(cls) -> List__Fast_API__Registry__Env_Vars:
        return List__Fast_API__Registry__Env_Vars([
            Schema__Fast_API__Registry__Env_Var(name=ENV_VAR__URL__TARGET_SERVER__CACHE_SERVICE            , required=True ),
            Schema__Fast_API__Registry__Env_Var(name=ENV_VAR__AUTH__TARGET_SERVER__CACHE_SERVICE__KEY_NAME , required=False),
            Schema__Fast_API__Registry__Env_Var(name=ENV_VAR__AUTH__TARGET_SERVER__CACHE_SERVICE__KEY_VALUE, required=False),
        ])

    @classmethod
    def client_name(cls) -> str:
        return 'Cache__Service__Client'
```

#### Registration Helper (Simple Function)

```python
# mgraph_ai_service_cache/registration/register_cache_service.py

from osbot_fast_api.services.registry.Fast_API__Service__Registry                               import Fast_API__Service__Registry
from osbot_fast_api.services.schemas.registry.enums.Enum__Fast_API__Service__Registry__Client__Mode import Enum__Fast_API__Service__Registry__Client__Mode
from mgraph_ai_service_cache.fast_api.Cache_Service__Fast_API                                   import Cache_Service__Fast_API
from mgraph_ai_service_cache_client.client.Cache__Service__Client                               import Cache__Service__Client


def register_cache_service(registry: Fast_API__Service__Registry) -> Cache__Service__Client:
    """Register cache service client in IN_MEMORY mode."""
    
    # Create FastAPI app (server-side)
    fast_api = Cache_Service__Fast_API().setup()
    
    # Create and configure client
    client = Cache__Service__Client()
    client.config.mode         = Enum__Fast_API__Service__Registry__Client__Mode.IN_MEMORY
    client.config.fast_api_app = fast_api.app()
    
    # Register
    registry.register(client)
    
    return client
```

### 2.4 Config Flow

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                          Registration Time                                    │
│                                                                              │
│   register_cache_service(registry)                                           │
│       │                                                                      │
│       ├── Creates Cache__Service__Client                                     │
│       ├── Sets client.config.mode = IN_MEMORY                                │
│       ├── Sets client.config.fast_api_app = <FastAPI instance>               │
│       └── registry.register(client)                                          │
│               │                                                              │
│               └── registry.clients[Cache__Service__Client] = client          │
└──────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│                           Request Time                                        │
│                                                                              │
│   client = registry.client(Cache__Service__Client)                           │
│   client.store().store__json__cache_key(...)                                 │
│       │                                                                      │
│       └── Service__Client__File__Store._client.requests().execute(...)       │
│               │                                                              │
│               └── Fast_API__Client__Requests.execute()                       │
│                       │                                                      │
│                       ├── config = registry.client(self.service_type).config │
│                       ├── if config.mode == IN_MEMORY:                       │
│                       │       └── TestClient(config.fast_api_app)            │
│                       └── elif config.mode == REMOTE:                        │
│                               └── requests.get(config.base_url + path)       │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## Part 3: Migration Guide

### 3.1 Files to Delete

| Package | File | Reason |
|---------|------|--------|
| `mgraph_ai_service_cache` | `Cache__Service__In_Memory.py` | Replaced by registration function |
| `mgraph_ai_service_cache_client` | `Cache__Service__Fast_API__Client.py` | Merged into `Cache__Service__Client` |
| `mgraph_ai_service_cache_client` | `Cache__Service__Fast_API__Client__Config.py` | Use registry config |
| `mgraph_ai_service_cache_client` | `Cache__Service__Registry__Client.py` | Merged into `Cache__Service__Client` |

### 3.2 Files to Create

| Package | File | Purpose |
|---------|------|---------|
| `osbot_fast_api` | `Fast_API__Client__Requests.py` | Generic transport |
| `mgraph_ai_service_cache_client` | `Cache__Service__Client.py` | Unified domain client |
| `mgraph_ai_service_cache_client` | `Cache__Service__Client__Requests.py` | Domain-specific requests |
| `mgraph_ai_service_cache` | `registration/register_cache_service.py` | Registration helper |

### 3.3 Files to Modify

| Package | File | Changes |
|---------|------|---------|
| `osbot_fast_api` | `Fast_API__Service__Registry__Client__Base.py` | Add `requests()` method returning base requests |
| All domain operation files | `Service__Client__File__Store.py`, etc. | Update imports from old client to new |

### 3.4 Migration Order

1. **osbot_fast_api**: Add `Fast_API__Client__Requests.py`
2. **mgraph_ai_service_cache_client**: Create `Cache__Service__Client.py` and `Cache__Service__Client__Requests.py`
3. **mgraph_ai_service_cache_client**: Update domain operation files to import from new client
4. **mgraph_ai_service_cache**: Create `registration/register_cache_service.py`
5. **mgraph_ai_service_cache**: Delete `Cache__Service__In_Memory.py`
6. **mgraph_ai_service_cache_client**: Delete old client files
7. **Update tests** to use new registration pattern

---

## Part 4: Usage Patterns

### 4.1 Test Setup (IN_MEMORY Mode)

```python
from osbot_fast_api.services.registry.Fast_API__Service__Registry import Fast_API__Service__Registry
from mgraph_ai_service_cache.registration.register_cache_service  import register_cache_service
from mgraph_ai_service_cache_client.client.Cache__Service__Client import Cache__Service__Client


class test_Something(TestCase):

    @classmethod
    def setUpClass(cls):
        cls.registry = Fast_API__Service__Registry()
        register_cache_service(cls.registry)

    def test__cache_operations(self):
        client = self.registry.client(Cache__Service__Client)
        result = client.store().store__json__cache_key(...)
        assert result is not None
```

### 4.2 Production Setup (REMOTE Mode)

```python
from osbot_fast_api.services.registry.Fast_API__Service__Registry import fast_api__service__registry
from osbot_fast_api.services.schemas.registry.enums.Enum__Fast_API__Service__Registry__Client__Mode import Enum__Fast_API__Service__Registry__Client__Mode
from mgraph_ai_service_cache_client.client.Cache__Service__Client import Cache__Service__Client


def setup_production_registry():
    client = Cache__Service__Client()
    client.config.mode          = Enum__Fast_API__Service__Registry__Client__Mode.REMOTE
    client.config.base_url      = "https://cache.prod.example.com"
    client.config.api_key_name  = "X-API-KEY"
    client.config.api_key_value = os.environ["CACHE_API_KEY"]
    
    fast_api__service__registry.register(client)
```

### 4.3 Service Consumer Pattern

```python
# Any service that needs cache
class Html_Graph__Service(Type_Safe):
    
    def cache_client(self) -> Cache__Service__Client:
        client = fast_api__service__registry.client(Cache__Service__Client)
        if client is None:
            raise ValueError("Cache service not registered")
        return client
    
    def process(self, data):
        # Use cache transparently - doesn't know/care about IN_MEMORY vs REMOTE
        cached = self.cache_client().retrieve().retrieve__cache_id(...)
        if cached:
            return cached
        # ... process and store
```

---

## Part 5: Benefits

### 5.1 Reduced Complexity

| Before | After |
|--------|-------|
| 3+ classes per service client | 1 class per service client |
| Duplicated transport logic | Shared `Fast_API__Client__Requests` |
| Duplicated config schemas | Single `Fast_API__Service__Registry__Client__Config` |
| Wrapper classes (`__In_Memory`, `__Registry__Client`) | Simple registration functions |

### 5.2 Clear Ownership

- **osbot_fast_api**: Owns transport, registry, base classes
- **Service Client packages**: Own domain methods only
- **Service packages**: Own registration helpers for IN_MEMORY mode

### 5.3 Testability

- No mocks needed — IN_MEMORY mode uses real FastAPI app
- ~100ms startup time for full service stack
- Same code paths in tests and production

### 5.4 Extensibility

Adding a new service client:

```python
class New__Service__Client(Fast_API__Service__Registry__Client__Base):
    
    @cache_on_self
    def requests(self):
        requests = New__Service__Client__Requests()
        requests.service_type = New__Service__Client
        return requests
    
    # Domain methods...
    def do_something(self):
        return self.requests().execute("POST", "/something", body={...})
```

---

## Part 6: Open Questions

1. **Result schema**: Should `Fast_API__Client__Requests.execute()` return a generic result schema, or raw response?

2. **Error handling**: Should transport raise exceptions or return error results?

3. **Registry scope**: Single global singleton vs per-application registry instances?

4. **Async support**: Should `Fast_API__Client__Requests` support async execution?

---

## Appendix A: Class Renaming Summary

| Old Name | New Name |
|----------|----------|
| `Cache__Service__Fast_API__Client` | `Cache__Service__Client` |
| `Cache__Service__Registry__Client` | `Cache__Service__Client` |
| `Cache__Service__Fast_API__Client__Config` | (use `Fast_API__Service__Registry__Client__Config`) |
| `Cache__Service__Fast_API__Client__Requests` | `Cache__Service__Client__Requests` |
| `Html_Graph__Service__Fast_API__Client` | `Html_Graph__Service__Client` |
| `LLM__Service__Fast_API__Client` | `LLM__Service__Client` |

## Appendix B: Package Dependencies (Unchanged)

```
┌─────────────────────────────────────┐
│       osbot_fast_api                │  ◄── Infrastructure (no service dependencies)
└─────────────────────────────────────┘
                ▲
                │
┌───────────────┴─────────────────────┐
│  mgraph_ai_service_cache_client     │  ◄── Light (schemas + client)
└─────────────────────────────────────┘
                ▲
                │
┌───────────────┴─────────────────────┐
│  mgraph_ai_service_cache            │  ◄── Heavy (FastAPI + business logic)
└─────────────────────────────────────┘
```

This dependency direction is **unchanged** — the architecture works within existing constraints.