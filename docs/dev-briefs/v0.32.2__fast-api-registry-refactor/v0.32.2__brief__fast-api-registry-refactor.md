# Dev Brief: Fast API Registry Refactoring

**Version**: v0.32.2
**Date**: January 2025
**Status**: Complete - All Phases (see debrief)
**Source**: TODOs extracted from `osbot_fast_api/services/` and related tests

---

## Overview

The Fast API Registry was recently added to enable service client discovery with zero-code-change switching between `IN_MEMORY` and `REMOTE` modes. This dev brief captures the refactoring tasks identified during initial implementation.

---

## Task Categories

### 1. Class Renaming (Naming Convention Alignment)

All classes need to follow the `Fast_API__` prefix convention for consistency.

| Current Name | New Name | File |
|-------------|----------|------|
| `Services__Registry` | `Fast_API__Service__Registry` | `services/registry/Services__Registry.py` |
| `Service__Client__Base` | `Fast_API__Service__Registry__Client__Base` | `services/registry/Service__Client__Base.py` |
| `Schema__Service__Client__Config` | `Fast_API__Service__Registry__Client__Config` | `services/schemas/registry/Schema__Service__Client__Config.py` |
| `Schema__Env_Var` | `Schema__Fast_API__Registry__Env_Var` | `services/schemas/registry/Schema__Env_Var.py` |
| `Dict__Clients__By_Type` | `Dict__Fast_API__Service__Clients_By_Type` | `services/schemas/registry/collections/Dict__Clients__By_Type.py` |
| `List__Client_Types` | `List__Fast_API__Service__Client_Types` | `services/schemas/registry/collections/List__Client_Types.py` |
| `List__Env_Vars` | `List__Fast_API__Registry__Env_Vars` | `services/schemas/registry/collections/List__Env_Vars.py` |
| `Safe_Str__API_Key__Name` | `Safe_Str__Fast_API__Auth__Key_Name` | `services/schemas/registry/safe_str/Safe_Str__API_Key__Name.py` |
| `Safe_Str__API_Key__Value` | `Safe_Str__Fast_API__Auth__Key_Value` | `services/schemas/registry/safe_str/Safe_Str__API_Key__Value.py` |

**Note**: File renames should match class names.

---

### 2. Architecture Refactoring

#### 2.1 Services__Registry: Static to Instance-Based

**Current State**:
```python
class Services__Registry:
    _clients : Dict__Clients__By_Type = None   # Class-level storage (lazy initialized)

    @classmethod
    def clients(cls) -> Dict__Clients__By_Type:
        if cls._clients is None:
            cls._clients = Dict__Clients__By_Type()
        return cls._clients
```

**Target State**:
```python
class Fast_API__Service__Registry(Type_Safe):
    clients : Dict__Fast_API__Service__Clients_By_Type   # Type_Safe auto-creates

    def register(self, client: Fast_API__Service__Registry__Client__Base) -> None:
        self.clients[type(client)] = client

# Singleton at module level
fast_api__service_registry = Fast_API__Service__Registry()
```

**Benefits**:
- Removes manual lazy initialization (`_clients = None`)
- Leverages Type_Safe's automatic field initialization
- Follows instance-based pattern used elsewhere in codebase
- Enables proper Type_Safe method decorators

---

### 3. New Schema Types

#### 3.1 Environment Variable Schemas

Create dedicated schema types for environment variable names and values:

| New Type | Purpose | Location |
|----------|---------|----------|
| `Schema__Env_Var__Name` | Type-safe env var name | `services/schemas/registry/` |
| `Schema__Env_Var__Value` | Type-safe env var value | `services/schemas/registry/` |

**Note**: Consider refactoring these to OSBot-Utils project for reuse.

---

### 4. Test Improvements

#### 4.1 Integration Tests

**Current Gap**: Only unit tests exist. No tests verify actual FastAPI behavior.

**Required Tests**:
- IN_MEMORY mode with TestClient
- REMOTE mode with actual HTTP requests
- Mode switching between IN_MEMORY and REMOTE
- Environment variable configuration
- Health check verification

**Approach**: Leverage `OSBot_Utils.Temp_Web_Server` for integration tests.

#### 4.2 Mock Client Naming

**Current**: `Mock__Client__Alpha`, `Mock__Client__Beta`

**Consider**: Alternative naming for test doubles:
- `Test__Client__Alpha`
- `Stub__Client__Alpha`
- `Fake__Client__Alpha`

---

## Implementation Order

### Phase 1: Naming Convention
1. Rename all classes to `Fast_API__*` convention
2. Rename files to match class names
3. Update all imports across codebase
4. Run tests to verify no regressions

### Phase 2: Architecture
1. Convert `Services__Registry` to Type_Safe instance-based
2. Remove lazy initialization pattern
3. Update singleton usage
4. Update tests

### Phase 3: New Types
1. Create `Schema__Env_Var__Name` and `Schema__Env_Var__Value`
2. Update `Schema__Env_Var` to use new types
3. Document for potential OSBot-Utils migration

### Phase 4: Integration Tests
1. Create integration test file
2. Implement IN_MEMORY mode tests
3. Implement REMOTE mode tests (using Temp_Web_Server)
4. Add mode switching tests

---

## Files Affected

### Source Files (9)
- `osbot_fast_api/services/registry/Services__Registry.py`
- `osbot_fast_api/services/registry/Service__Client__Base.py`
- `osbot_fast_api/services/schemas/registry/Schema__Env_Var.py`
- `osbot_fast_api/services/schemas/registry/Schema__Service__Client__Config.py`
- `osbot_fast_api/services/schemas/registry/collections/Dict__Clients__By_Type.py`
- `osbot_fast_api/services/schemas/registry/collections/List__Client_Types.py`
- `osbot_fast_api/services/schemas/registry/collections/List__Env_Vars.py`
- `osbot_fast_api/services/schemas/registry/safe_str/Safe_Str__API_Key__Name.py`
- `osbot_fast_api/services/schemas/registry/safe_str/Safe_Str__API_Key__Value.py`

### Test Files (4+)
- `tests/unit/services/registry/test_Services__Registry.py`
- `tests/unit/services/registry/test_Service__Client__Base.py`
- `tests/unit/services/registry/mock_clients/Mock__Client__Alpha.py`
- `tests/unit/services/registry/mock_clients/Mock__Client__Beta.py`
- (new) `tests/integration/services/registry/test_Services__Registry__Integration.py`

---

## Original TODOs (Verbatim)

### Services__Registry.py:12-16
```
# todo: rename this class to Fast_API__Service__Registry
#       this class needs to be refactored to not use static methods where _clients is an instance variable
#       and the main static reference for the shared (singleton method) is retrieve by the "fast_api__service_registry = Services__Registry() " that can be seen at the end of this file
#       this means that we can make the Services__Registry a Type_Safe class and remove the None assigment, since Type_Safe will then create that _clients object
#       rename '_clients' with 'clients
```

### Service__Client__Base.py:12
```
# todo: rename this class to Fast_API__Service__Registry__Client__Base
```

### Schema__Env_Var.py:9-13
```
# todo: refactor this class to be Schema__Fast_API__Registry__Env_Var
#     : also:
#           name should a type of Schema__Env_Var__Name (which needs to be created)
#           we should also create an Schema__Env_Var__Value
#           add note to refactor these to the OSbot-Utils project
```

### Schema__Service__Client__Config.py:13
```
# todo: rename this class to Fast_API__Service__Registry__Client__Config
```

### Dict__Clients__By_Type.py:9
```
# todo: rename this class to Dict__Fast_API__Service__Clients_By_Type
```

### List__Client_Types.py:9
```
# todo: rename this class to List__Fast_API__Service__Client_Types
```

### List__Env_Vars.py:9
```
# todo: rename this class to List__Fast_API__Registry__Env_Vars
```

### Safe_Str__API_Key__Name.py:9
```
# todo: refactor to Safe_Str__Fast_API__Auth__Key_Name
```

### Safe_Str__API_Key__Value.py:9
```
# todo: rename to Safe_Str__Fast_API__Auth__Key_Name
```
*(Note: This appears to be a copy-paste error - should likely be `Safe_Str__Fast_API__Auth__Key_Value`)*

### test_Services__Registry.py:123-124
```
# todo: add a new set of integration tests (here and for each of the Mock_Client*_) that actually simulates a Fast_API environment
#       and tests that check that the in memory mode and remote works as expected (leverage OSBot_Utils Temp_Web_Server)
```

### Mock__Client__Beta.py:10
```
# todo: see if we can find a better name than Mock__* for these test doubles
```
